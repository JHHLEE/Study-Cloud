<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="product">	


	<insert id="insertProduct" parameterType="pdto">
		<selectKey keyProperty="nextval" resultType="int">
	select seq_pro_num.nextval from dual
	</selectKey>
		insert into map values(
    #{nextval},
    #{proName},#{proAddress},#{proPhone})
	</insert>

	<insert id="insertProduct2" parameterType="pdto">
	<selectKey keyProperty="proNum" resultType="int">
	select seq_pro_num.nextval from dual
	</selectKey>
	INSERT ALL 
	INTO PRODUCT VALUES
	(#{proNum},'',#{proPost},#{proInfo},#{proNotice},#{proRefund},#{proZipcode})
	INTO PRODUCTFILE VALUES
	(#{proNum}, #{proPicOriginal},#{proPicRename})
	select * from dual
	</insert>
	
	<!-- productList 화면 -->
	<select id="selectList" resultType="pdvo">
		SELECT PRO_NUM
      		 , PRO_NAME
             , SUBSTR(PRO_ADDRESS,3) AS PRO_ADDRESS
             , PRO_PHONE
             , MIN(PRO_PRICE) AS PRO_PRICE
		  FROM MAP 
    LEFT OUTER JOIN PRODUCT
         USING (PRO_NUM)
    LEFT OUTER JOIN PROTIME 
         USING (PRO_NUM)
   <trim prefix="WHERE" prefixOverrides="AND|OR">
       <if test="proAddress != null and proAddress neq ''">
         PRO_ADDRESS LIKE '%'||#{proAddress}||'%'
       </if>
       <if test="proUseTime != null and proUseTime neq ''">
         OR PRO_USE_TIME = #{proUseTime}
       </if>
   </trim>         
         GROUP BY (PRO_NUM, PRO_NAME, PRO_ADDRESS, PRO_PHONE)
         ORDER BY PRO_NUM
	</select>
	
	<!-- productList 페이징 count -->
	<select id="selectOneCount" resultType="_int">
	SELECT COUNT(*) CNT
	  FROM MAP 
      LEFT OUTER JOIN PRODUCT
     USING (PRO_NUM)
	<if test="proUseTime != null and proUseTime neq ''">
      LEFT OUTER JOIN PROTIME 
     USING (PRO_NUM) 
	</if>
	<trim prefix="WHERE" prefixOverrides="AND|OR">
       <if test="proAddress != null and proAddress neq ''">
         PRO_ADDRESS LIKE '%'||#{proAddress}||'%'
       </if>
       <if test="proUseTime != null and proUseTime neq ''">
         OR PRO_USE_TIME = #{proUseTime}
       </if>
    </trim> 
    </select>
	
	
	
	
<!-- 	상세 페이지 화면 -->
	<!-- <select id="proDetail"  resultType="pdto">
	SELECT
			pro_num 
		  ,pro_name
		  ,pro_post
		  ,pro_info
		  ,pro_notice
		  ,pro_refund
		  ,pro_phone
		  from map
    LEFT OUTER JOIN PRODUCT
         USING (PRO_NUM)
    LEFT OUTER JOIN PROTIME 
         USING (PRO_NUM)
         where pro_num = #{proNum}
	WHERE PRO_NUM LIKE '%'||#{proNum}||'%'

	</select> -->
	<select id="proDetail"  resultType="pdto">
		SELECT *
		  FROM MAP
	LEFT OUTER JOIN PRODUCT
	     USING (PRO_NUM)
	LEFT OUTER JOIN PROTIME 
	     USING (PRO_NUM)
	     WHERE PRO_NUM = #{proNum}
	</select>
	<!-- product detail qna -->
	<insert id="insertQna" parameterType="qvo">
		INSERT INTO QNA VALUES(
		       #{proNum}
	    	 , (SELECT PRO_NAME FROM MAP WHERE PRO_NUM = #{proNum})
			 , #{memId}
		     , #{memQuestion}
			 , (SELECT MEM_AUTHORITY FROM MEMBER WHERE MEM_ID = #{memId})
			 , NULL
		     , SYSDATE
		     , (SELECT NVL(MAX(QNA_NUM), 0)+1 FROM QNA)
		)
	</insert>
		
	<update id="updateQna" parameterType="qvo">
		UPDATE QNA
   		   SET MEM_QUESTION = #{memQuestion}
         WHERE QNA_NUM = #{qnaNum}
	</update>
	
	<update id="updateReply" parameterType="qvo">
		UPDATE QNA
   		   SET HOST_ANSWER = #{hostAnswer}
         WHERE QNA_NUM = #{qnaNum}
	</update>
	
	<delete id="deleteQna" parameterType="qvo">
		DELETE FROM QNA WHERE QNA_NUM = #{qnaNum}
	</delete>
	
	<!-- detail qna 페이징 count -->
	<select id="selectQnaCount" resultType="_int">
		SELECT COUNT(*) FROM QNA WHERE PRO_NUM = #{proNum}
	</select>
	
	<select id="selectQnaList" resultType="qvo">
		SELECT * 
		  FROM QNA
	    <if test="proNum != null and proNum neq ''">
         WHERE PRO_NUM = #{proNum}
   	    </if>		 
		 ORDER BY QNA_DATE DESC
	</select>
	
	
	
	
	<!-- 호스트 & 어드민 상품목록 -->
	
	<select id="hostProductList" resultType="hostProDto">
	select
		 pro_num
        ,pro_name
        ,pro_address
        ,pro_phone
        ,mem_id
        ,mem_authority
        from map
        left outer join product
        using (pro_num)
        left outer join member
        using (mem_id)
	 	</select>
	<select id="productOneCnt" resultType="_int">

	SELECT COUNT(*) CNT
	  FROM MAP 
     	LEFT OUTER JOIN PRODUCT
        USING (PRO_NUM)     
    	LEFT OUTER JOIN MEMBER
        USING (MEM_ID)
        WHERE PRO_NUM = #{proNum}
	
	</select>
	<select id="hostList"  resultType="hostProDto">
	select  pro_num
        ,pro_name
        ,pro_address
        ,pro_phone
        ,mem_id
        ,mem_authority
        from map
        left outer join product
        using (pro_num)
        left outer join member
        using (mem_id)
         <if test="proNum != null and proNum neq ''">
         WHERE PRO_NUM = #{proNum}
   	    </if>		
        order by pro_num desc
	 
	</select>
	
	
	
	
	
</mapper>
