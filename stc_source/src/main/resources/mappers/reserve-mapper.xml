<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="reserve">

	<resultMap type="rsvvo" id="rvoMap">
		<id column="RSV_NUM" property="rsvNum" />
		<result column="RSV_DATE" property="rsvDate" />
		<result column="RSV_PERSON" property="rsvPerson" />
		<result column="RSV_AMOUNT" property="rsvAmount" />
		<result column="RSV_STATUS" property="rsvStatus" />
		<result column="RSV_TIME" property="rsvTime" />
		<result column="PRO_NUM" property="proNum" />
	</resultMap>
	
	<!-- 예약하기 -->
	<insert id="insertReservation" parameterType="study.cloud.stc.reserve.model.vo.ReserveTimeReqDto">
		<!-- <selectKey order="BEFORE" keyProperty="rsvNum" resultType="_int">
		SELECT (NVL(MAX(RSV_NUM),0) + 1) as rsvNum FROM RESERVE
		</selectKey>
		<selectKey order="AFTER" keyProperty="rsvNumAfter"  resultType="_int">
		SELECT (NVL(MAX(RSV_NUM),0) + 1) as rsvNum FROM RESERVE
		</selectKey> -->
		INSERT ALL
		<foreach collection="rsvTime" item="rsvTime" index="index">
		INTO RESERVE VALUES (
		(SELECT (NVL(MAX(RSV_NUM),0) + #{index} + 1) FROM RESERVE)
		<!-- (#{rsvNum} + #{index}) -->
		, to_date((#{rsvDate}||''||#{rsvTime}), 'yyyy-mm-ddhh24')
		, #{rsvPerson}
		, #{memId}
		, ( select (#{rsvPerson}* pro_price ) from protime where  pro_num = #{proNum} and pro_date = to_date((#{rsvDate}||''||#{rsvTime}), 'yyyy-mm-ddhh24')   )
		, 0
		, #{rsvTime}
		, sysdate
		,#{proNum})
		</foreach>
		select * from dual
	</insert>
	
	<update id="updateRsvNumToProTime" parameterType="map">
		<selectKey order="BEFORE" keyProperty="rsvNum" resultType="_int">
		 select rsv_num from reserve where  pro_num = #{proNum} and rsv_date = to_date((#{rsvDate}||''||#{rsvTime}), 'yyyy-mm-ddhh24')
		</selectKey>
		update protime 
		set rsv_num = #{rsvNum}
		where  pro_num = #{proNum} and pro_date = to_date((#{rsvDate}||''||#{rsvTime}), 'yyyy-mm-ddhh24')
	</update>
	<!-- 
	<update id="updateRsvNumToProTime" parameterType="study.cloud.stc.reserve.model.vo.ReserveTimeReqDto">
		update protime 
		set rsv_num = (select rsv_num from reserve where  pro_num = #{proNum} and rsv_date = to_date((#{rsvDate}||''||#{rsvTime}), 'yyyy-mm-ddhh24'))
		where  pro_num = #{proNum} 
		<foreach collection="rsvTime" item="rtime" index="index" open="and (" separator="OR" close=")">
			  pro_date = to_date((#{rsvDate}||''||#{rtime}), 'yyyy-mm-ddhh24')
		</foreach>
	</update>
	 -->
	
	<select id="selectProName" parameterType="study.cloud.stc.reserve.model.vo.ReserveTimeReqDto" resultType="study.cloud.stc.reserve.model.vo.MapVo">
		select pro_num, pro_name, pro_phone from map where pro_num = #{proNum}
	</select>
	
	<select id="selectProNameList" resultType="study.cloud.stc.reserve.model.vo.MapVo">
		select pro_num, pro_name from map where pro_num in (select distinct pro_num from reserve)
	</select>

	<delete id="rsvdelete">
		DELETE FROM reserve WHERE RSV_NUM = #{rsvNum}
	</delete>

	<select id="rsvselectOne" resultType="rsvvo">
		SELECT RSV_NUM, RSV_DATE, RSV_PERSON, MEM_ID, RSV_AMOUNT, RSV_STATUS, RSV_TIME
		FROM reserve WHERE MEM_ID='${memId}' order by RSV_NUM
	</select>

	<select id="selectReserveList" parameterType="study.cloud.stc.reserve.model.vo.ReserveTimeReqDto" resultType="rsvvo">
		SELECT RSV_NUM, RSV_DATE, RSV_PERSON, MEM_ID, RSV_AMOUNT, RSV_STATUS, RSV_TIME, PRO_NUM
		FROM RESERVE WHERE MEM_ID='${memId}' AND RSV_DATE >= TO_DATE(SYSDATE, 'yyyy-mm-dd') ORDER BY RSV_NUM
	</select>

	<select id="rsvselectCount" resultType="_int">
		SELECT COUNT(*) FROM reserve
	</select>
	
	<select id="selectTimePriceRsvList" resultType="study.cloud.stc.product.model.vo.ProductTimePriceDto">
		SELECT to_char(pro_date, 'hh24') time, pro_price price, rsv_num, PRO_NUM 
		FROM PROTIME  
		where PRO_NUM =#{proNum} and trunc(pro_date) =  #{proDate}
		order by time
	</select>
	
</mapper>
